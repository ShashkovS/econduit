(function(){$.fn.floatHeader=function(){return this.each(function(){var d=$(this);d.floatBox=d.siblings(".floatHeader");var e=d.floatBox.children("table");$(window).scroll(function(){if(c(d,d.floatBox)){if(!d.floatBox.is(":visible")){b(e,d)}d.floatBox.show().css({top:0,left:d.offset().left-$(window).scrollLeft()})}else{d.floatBox.hide()}});$(window).resize(function(){if(d.floatBox.is(":visible")){b(e,d)}});this.fhRecalculate=function(){b(e,d)}})};function b(f,e){var d=e.width();if(navigator.userAgent.indexOf("Firefox")>-1&&d<window.innerWidth){f.css("width","")}else{f.width(d)}var g=f.find("thead th:first-child");e.find("th").each(function(h,i){g=g.width($(i).width()).next()})}function c(g,f){if(!g.is(":visible")||!show_floating_header){return false}var i=$(window).scrollTop();var h=g.offset().top;var d=g.height()-f.height();var e=g.children("tfoot");if(e.length>0){d-=e.height()}return h<=i&&i<=h+d}function a(){var t=false;var l={};var q=[];this.show_floating_header=true;function e(){if(t){var F=this.cellIndex;var K=$(this).parent()[0].sectionRowIndex;if(F<l.x){var H=F;var J=l.x}else{var H=l.x;var J=F}if(K<l.y){var G=K;var I=l.y}else{var G=l.y;var I=K}$(this).closest("tbody").children().slice(G,I+1).each(function(){$(this).children(".pupilName").addClass("mouseOver").end().children().slice(H,J+1).addClass("mouseOver")});$(this).closest(".conduit_container").find(".headerRow").each(function(){$(this).children().slice(H,J+1).addClass("mouseOver")})}else{$(this).siblings(".pupilName").andSelf().addClass("mouseOver");$(this).closest(".conduit_container").find(".headerRow").children(":nth-child("+(this.cellIndex+1)+")").addClass("mouseOver")}}function f(){$(this).parent().addClass("mouseOver")}function d(){$(this).closest(".conduit_container").find("tr").children(":nth-child("+(this.cellIndex+1)+")").addClass("mouseOver")}function i(){$(this).closest(".conduit_container").find("*").removeClass("mouseOver")}function p(){var G=Globals.ClassID,F=$(this).attr("data-id"),H=$(this).closest("li");if($(this).attr("data-state")==="opened"){$(this).attr("data-state","closed");j(G,F,false);H.removeClass("print")}else{if($(this).attr("data-state")==="empty"){var J=$(this).siblings(".conduit_container"),I=$(this).siblings(".loading");I.show();$.ajax({type:"POST",url:"ajax/GetConduit.php",data:{List:F},dataType:"html",success:function(K){I.hide();J.html(K);J.children(".conduit").floatHeader();E(J);D(J)},error:function(K,M,L){alert("Не удалось получить ответ от сервера: "+K.status+" "+M)}})}$(this).attr("data-state","opened");j(G,F,true);H.addClass("print")}}function j(H,F,I){var G="ec_open",J=($.cookie(G)||"").split(","),K=$.inArray(F,J);if(I&&(K==-1)){J.push(F)}else{if(!I&&(K!=-1)){J.splice(K,1)}}$.cookie(G,J.join(","),{expires:30})}function w(F,J,I,H,G){$row=J.find("tbody tr").eq(H);if($row.is(":visible")){F.push({Pupil:$row.attr("data-pupil"),Problem:J.find(".headerRow").eq(0).children().eq(I).attr("data-problem"),Mark:G})}}function v(F,G){if(F==="update"){q.push(G)}else{G=q[q.length-1]}$.ajax({type:"POST",url:"ajax/UpdateMark.php",data:{Request:JSON.stringify(G),Type:F},dataType:"json",context:$('.conduit_container[data-id="'+G.List+'"]>.conduit').eq(0),success:function(J){for(var L=0,I=J.length;L<I;L++){var H=this.find(".headerRow").eq(0).children('[data-problem="'+J[L].Problem+'"]')[0].cellIndex;var K=this.find('tr[data-pupil="'+J[L].Pupil+'"]').children().eq(H);K.html(J[L].Text);if(typeof(J[L].Hint)!=="undefined"){K.attr({"data-mark":J[L].Mark,title:J[L].Hint})}else{K.removeAttr("data-mark").removeAttr("title")}if($("#autoCaption").val()===J[L].Mark&&J[L].Mark!==""){K.addClass("highlighted")}else{K.removeClass("highlighted")}}if(F==="rollback"){q.pop();if(q.length===0){$("#undoButton").attr("disabled","disabled")}}else{$("#undoButton").removeAttr("disabled")}this[0].fhRecalculate()},error:function(H,K,I){var J="Не удалось обновить данные на сервере: ";alert(J+H.status+" "+K)}})}function h(){if(q.length>0){v("rollback")}}function g(F){$("#mode").attr("data-state",F).text(["Обычный ввод","Удалить один раз","Удалять всегда"][F])}function k(){t=false;delete l;i()}function r(G){var R=this.cellIndex;var P=$(this).parent()[0].sectionRowIndex;var I=$(this).closest(".conduit_container").attr("data-id");var L=$(this).closest(".conduit");var H=[];var O;if(G.altKey||+$("#mode").attr("data-state")){O=""}else{O=$("#autoCaption").val()}if(t){if(R<l.x){var M=R;var N=l.x}else{var M=l.x;var N=R}if(P<l.y){var Q=P;var F=l.y}else{var Q=l.y;var F=P}for(var K=M;K<=N;K++){for(var J=Q;J<=F;J++){w(H,L,K,J,O)}}k();H.List=I;v("update",H)}else{if(G.shiftKey){t=true;l={x:R,y:P}}else{w(H,L,R,P,O);H.List=I;v("update",H)}}if($("#mode").attr("data-state")==1){g(0)}}function E(G){G=G||$("#conduits");var F=$("#autoCaption").val();if(F!==""){G.find('.conduit td[data-mark="'+F+'"]').addClass("highlighted")}}function u(){$(".conduit td").removeClass("highlighted")}function m(){u();E()}function D(H){H=H||$("#conduits");var G=$("#teacher").val();var F=$("#pupil").val();if(F===""&&G===""){$("#conduits").find(".conduit tfoot").show();this.show_floating_header=true}else{$("#conduits").find(".conduit tfoot").hide();this.show_floating_header=false}if(F===""){if(G===""){H.find(".conduit tbody tr").show()}else{H.find('.conduit tbody tr:not([data-teacher="'+G+'"])').hide();H.find('.conduit tbody tr[data-teacher="'+G+'"]').show()}}else{H.find('.conduit tbody tr:not([data-pupil="'+F+'"])').hide();H.find('.conduit tbody tr[data-pupil="'+F+'"]').show()}}function A(){$("#pupil").val("");D();q.length=0;$("#undoButton").attr("disabled","disabled")}function B(){D();q.length=0;$("#undoButton").attr("disabled","disabled")}function o(F){if(F===$("#pupil").val()){F=""}$("#pupil").val(F);D()}function y(){var F=$(this).closest("tr").attr("data-pupil");o(F)}function n(){if(longpress){return false}}function x(){var F=$(this).closest("tr").attr("data-pupil");longpress=false;pressTimer=window.setTimeout(function(G){o(G);longpress=true},750,F)}function z(){clearTimeout(pressTimer)}function C(F){var G=String.fromCharCode(F.which);if(F.ctrlKey&&G==="Z"){h()}else{if(F.which===27){k()}}if(!$("#autoCaption").is(":focus")){if(G>="1"&&G<="8"){$(".combobox select").prop("selectedIndex",G-1).change()}if(F.which>=97&&F.which<=104){$(".combobox select").prop("selectedIndex",F.which-97).change()}}}function s(){window.print()}this.init=function(){$("#autoCaption").change(m).keyup(m);var G=$.fn.Today();$("#autoCaption").datepicker({constrainInput:false,showButtonPanel:true,showOtherMonths:true,navigationAsDateFormat:true,changeMonth:true,defaultDate:G}).datepicker("setDate",G);$("#undoButton").click(h).attr("disabled","disabled");$("#mode").click(function(){g(($(this).attr("data-state")+1)%3)});$(".combobox select").change(function(){$(this.nextElementSibling).val(this.value).change();this.selectedIndex=-1}).prop("selectedIndex",-1);$(window).keyup(C);$("#teacher").change(A);$("#pupil").change(B);var F=$("#conduits");F.on({mouseover:d,mouseout:i},".conduit .problemName");F.on({mouseover:f,mouseout:i,dblclick:y},".conduit .pupilName");F.on({click:n,mousedown:x,mouseup:z},".conduit .pupilName");F.on({mouseover:e,mouseout:i,click:r},".conduit td");F.on({mouseleave:k},".conduit");F.on({click:p},".conduit_spoiler");F.on({click:s},".printButton")}}window.Conduit=new a()})();