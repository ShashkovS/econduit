(function(){$.fn.floatHeader=function(){return this.each(function(){var d=$(this);d.floatBox=d.siblings(".floatHeader");var e=d.floatBox.children("table");$(window).scroll(function(){if(c(d,d.floatBox)){if(!d.floatBox.is(":visible")){b(e,d)}d.floatBox.show().css({top:0,left:d.offset().left-$(window).scrollLeft()})}else{d.floatBox.hide()}});$(window).resize(function(){if(d.floatBox.is(":visible")){b(e,d)}});this.fhRecalculate=function(){b(e,d)}})};function b(f,e){var d=e.width();if(navigator.userAgent.indexOf("Firefox")>-1&&d<window.innerWidth){f.css("width","")}else{f.width(d)}var g=f.find("thead th:first-child");e.find("th").each(function(h,i){g=g.width($(i).width()).next()})}function c(g,f){if(!g.is(":visible")){return false}var i=$(window).scrollTop();var h=g.offset().top;var d=g.height()-f.height();var e=g.children("tfoot");if(e.length>0){d-=e.height()}return h<=i&&i<=h+d}function a(){var r=false;var l={};var o=[];function e(){if(r){var z=this.cellIndex;var E=$(this).parent()[0].sectionRowIndex;if(z<l.x){var B=z;var D=l.x}else{var B=l.x;var D=z}if(E<l.y){var A=E;var C=l.y}else{var A=l.y;var C=E}$(this).closest("tbody").children().slice(A,C+1).each(function(){$(this).children(".pupilName").addClass("mouseOver").end().children().slice(B,D+1).addClass("mouseOver")});$(this).closest(".conduit_container").find(".headerRow").each(function(){$(this).children().slice(B,D+1).addClass("mouseOver")})}else{$(this).siblings(".pupilName").andSelf().addClass("mouseOver");$(this).closest(".conduit_container").find(".headerRow").children(":nth-child("+(this.cellIndex+1)+")").addClass("mouseOver")}}function f(){$(this).parent().addClass("mouseOver")}function d(){$(this).closest(".conduit_container").find("tr").children(":nth-child("+(this.cellIndex+1)+")").addClass("mouseOver")}function i(){$(this).closest(".conduit_container").find("*").removeClass("mouseOver")}function n(){var z=Globals.ClassID,y=$(this).attr("data-id");if($(this).attr("data-state")==="opened"){$(this).attr("data-state","closed");j(z,y,false)}else{if($(this).attr("data-state")==="empty"){var B=$(this).siblings(".conduit_container"),A=$(this).siblings(".loading");A.show();$.ajax({type:"POST",url:"ajax/FillConduit.php",data:{List:y},dataType:"html",success:function(C){A.hide();B.html(C);B.children(".conduit").floatHeader();x(B);v(B)},error:function(C,E,D){alert("Не удалось получить ответ от сервера: "+C.status+" "+E)}})}$(this).attr("data-state","opened");j(z,y,true)}}function j(A,y,B){var z="SPOILER:"+A,C=(localStorage.getItem(z)||"").split(","),D=$.inArray(y,C);if(B&&(D==-1)){C.push(y)}else{if(!B&&(D!=-1)){C.splice(D,1)}}localStorage.setItem(z,C.join(","))}function u(y,C,B,A,z){$row=C.find("tbody tr").eq(A);if($row.is(":visible")){y.push({Pupil:$row.attr("data-pupil"),Problem:C.find(".headerRow").eq(0).children().eq(B).attr("data-problem"),Mark:z})}}function t(y,z){if(y==="update"){o.push(z)}else{z=o[o.length-1]}$.ajax({type:"POST",url:"ajax/UpdateMark.php",data:{Request:JSON.stringify(z),Type:y},dataType:"json",context:$('.conduit_container[data-id="'+z.List+'"]>.conduit').eq(0),success:function(C){for(var E=0,B=C.length;E<B;E++){var A=this.find(".headerRow").eq(0).children('[data-problem="'+C[E].Problem+'"]')[0].cellIndex;var D=this.find('tr[data-pupil="'+C[E].Pupil+'"]').children().eq(A);D.html(C[E].Text);if(typeof(C[E].Hint)!=="undefined"){D.attr({"data-mark":C[E].Mark,title:C[E].Hint})}else{D.removeAttr("data-mark").removeAttr("title")}if($("#autoCaption").val()===C[E].Mark&&C[E].Mark!==""){D.addClass("highlighted")}else{D.removeClass("highlighted")}}if(y==="rollback"){o.pop();if(o.length===0){$("#undoButton").attr("disabled","disabled")}}else{$("#undoButton").removeAttr("disabled")}this[0].fhRecalculate()},error:function(A,D,B){var C="Не удалось обновить данные на сервере: ";alert(C+A.status+" "+D)}})}function h(){if(o.length>0){t("rollback")}}function g(y){$("#mode").attr("data-state",y).text([" Обычный ввод"," Удалить один раз"," Удалять всегда"][y])}function k(){r=false;delete l;i()}function p(A){var L=this.cellIndex;var J=$(this).parent()[0].sectionRowIndex;var C=$(this).closest(".conduit_container").attr("data-id");var F=$(this).closest(".conduit");var B=[];var I;if(A.altKey||+$("#mode").attr("data-state")){I=""}else{I=$("#autoCaption").val()}if(r){if(L<l.x){var G=L;var H=l.x}else{var G=l.x;var H=L}if(J<l.y){var K=J;var z=l.y}else{var K=l.y;var z=J}for(var E=G;E<=H;E++){for(var D=K;D<=z;D++){u(B,F,E,D,I)}}k();B.List=C;t("update",B)}else{if(A.shiftKey){r=true;l={x:L,y:J}}else{u(B,F,L,J,I);B.List=C;t("update",B)}}if($("#mode").attr("data-state")==1){g(0)}}function x(z){z=z||$("#conduits");var y=$("#autoCaption").val();if(y!==""){z.find('.conduit td[data-mark="'+y+'"]').addClass("highlighted")}}function s(){$(".conduit td").removeClass("highlighted")}function m(){s();x()}function v(z){z=z||$("#conduits");var y=$("#teacher").val();if(y===""){z.find(".conduit tbody tr").show()}else{z.find('.conduit tbody tr:not([data-teacher="'+y+'"])').hide();z.find('.conduit tbody tr[data-teacher="'+y+'"]').show()}}function w(y){var z=String.fromCharCode(y.which);if(y.ctrlKey&&z==="Z"){h()}else{if(y.which===27){k()}}}function q(){var y=$(this).closest("li");y.addClass("print");window.print();y.removeClass("print")}this.init=function(){$("#autoCaption").change(m).keyup(m);var A=$.fn.Today();$("#autoCaption").datepicker({constrainInput:false,showButtonPanel:true,showOtherMonths:true,navigationAsDateFormat:true,changeMonth:true,defaultDate:A}).datepicker("setDate",A);$("#undoButton").click(h).attr("disabled","disabled");$("#mode").click(function(){g(($(this).attr("data-state")+1)%3)});$(window).keyup(w);$("#teacher").change(function(){v()});var z=$("#conduits");z.on({mouseover:d,mouseout:i},".conduit .problemName");z.on({mouseover:f,mouseout:i},".conduit .pupilName");z.on({mouseover:e,mouseout:i,click:p},".conduit td");z.on({mouseleave:k},".conduit");z.on({click:n},".conduit_spoiler");z.on({click:q},".printButton");var C="SPOILER:"+Globals.ClassID,D=(localStorage.getItem(C)||"").split(",");for(var B=1,y=D.length;B<y;++B){$(".conduit_spoiler[data-id="+D[B]+"]").click()}}}window.Conduit=new a()})();