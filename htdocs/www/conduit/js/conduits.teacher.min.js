(function(){$.fn.floatHeader=function(){return this.each(function(){var d=$(this);d.floatBox=d.siblings(".floatHeader");var e=d.floatBox.children("table");$(window).scroll(function(){if(c(d,d.floatBox)){if(!d.floatBox.is(":visible")){b(e,d)}d.floatBox.show().css({top:0,left:d.offset().left-$(window).scrollLeft()})}else{d.floatBox.hide()}});$(window).resize(function(){if(d.floatBox.is(":visible")){b(e,d)}});this.fhRecalculate=function(){b(e,d)}})};function b(f,e){var d=e.width();if(navigator.userAgent.indexOf("Firefox")>-1&&d<window.innerWidth){f.css("width","")}else{f.width(d)}var g=f.find("thead th:first-child");e.find("th").each(function(h,i){g=g.width($(i).width()).next()})}function c(g,f){if(!g.is(":visible")||!show_floating_header){return false}var i=$(window).scrollTop();var h=g.offset().top;var d=g.height()-f.height();var e=g.children("tfoot");if(e.length>0){d-=e.height()}return h<=i&&i<=h+d}function a(){var t=false;var l={};var q=[];this.show_floating_header=true;function e(){if(t){var G=this.cellIndex;var L=$(this).parent()[0].sectionRowIndex;if(G<l.x){var I=G;var K=l.x}else{var I=l.x;var K=G}if(L<l.y){var H=L;var J=l.y}else{var H=l.y;var J=L}$(this).closest("tbody").children().slice(H,J+1).each(function(){$(this).children(".pupilName").addClass("mouseOver").end().children().slice(I,K+1).addClass("mouseOver")});$(this).closest(".conduit_container").find(".headerRow").each(function(){$(this).children().slice(I,K+1).addClass("mouseOver")})}else{$(this).siblings(".pupilName").andSelf().addClass("mouseOver");$(this).closest(".conduit_container").find(".headerRow").children(":nth-child("+(this.cellIndex+1)+")").addClass("mouseOver")}}function f(){$(this).parent().addClass("mouseOver")}function d(){$(this).closest(".conduit_container").find("tr").children(":nth-child("+(this.cellIndex+1)+")").addClass("mouseOver")}function i(){$(this).closest(".conduit_container").find("*").removeClass("mouseOver")}function p(){var H=Globals.ClassID,G=$(this).attr("data-id"),I=$(this).closest("li");if($(this).attr("data-state")==="opened"){$(this).attr("data-state","closed");j(H,G,false);I.removeClass("print")}else{if($(this).attr("data-state")==="empty"){var K=$(this).siblings(".conduit_container"),J=$(this).siblings(".loading");J.show();$.ajax({type:"POST",url:"ajax/FillConduit.php",data:{List:G},dataType:"html",success:function(L){J.hide();K.html(L);K.children(".conduit").floatHeader();E(K);D(K)},error:function(L,N,M){alert("Не удалось получить ответ от сервера: "+L.status+" "+N)}})}$(this).attr("data-state","opened");j(H,G,true);I.addClass("print")}}function j(I,G,J){var H="SPOILER:"+I,K=(localStorage.getItem(H)||"").split(","),L=$.inArray(G,K);if(J&&(L==-1)){K.push(G)}else{if(!J&&(L!=-1)){K.splice(L,1)}}localStorage.setItem(H,K.join(","))}function w(H,L,K,J,I){$row=L.find("tbody tr").eq(J);if($row.is(":visible")){H.push({Pupil:$row.attr("data-pupil"),Problem:L.find(".headerRow").eq(0).children().eq(K).attr("data-problem"),Mark:I});var G=$row.children().eq(K);G.removeClass("loading_error");G.addClass("loading")}}function v(G,H){if(G==="update"){q.push(H)}else{H=q[q.length-1]}$.ajax({type:"POST",url:"ajax/UpdateMark.php",data:{Request:JSON.stringify(H),Type:G},dataType:"json",context:$('.conduit_container[data-id="'+H.List+'"]>.conduit').eq(0),success:function(K){for(var M=0,J=K.length;M<J;M++){var I=this.find(".headerRow").eq(0).children('[data-problem="'+K[M].Problem+'"]')[0].cellIndex;var L=this.find('tr[data-pupil="'+K[M].Pupil+'"]').children().eq(I);L.html(K[M].Text);L.removeClass("loading");if(typeof(K[M].Hint)!=="undefined"){L.attr({"data-mark":K[M].Mark,title:K[M].Hint})}else{L.removeAttr("data-mark").removeAttr("title")}if($("#autoCaption").val()===K[M].Mark&&K[M].Mark!==""){L.addClass("highlighted")}else{L.removeClass("highlighted")}}if(G==="rollback"){q.pop();if(q.length===0){$("#undoButton").attr("disabled","disabled")}}else{$("#undoButton").removeAttr("disabled")}this[0].fhRecalculate()},error:F(H)})}function F(G){return function(L,O,M){var N="Не удалось обновить данные на сервере: ";alert(N+L.status+" "+O);for(var K=0,I=G.length;K<I;++K){var H=this.find(".headerRow").eq(0).children('[data-problem="'+G[K].Problem+'"]')[0].cellIndex;var J=this.find('tr[data-pupil="'+G[K].Pupil+'"]').children().eq(H);J.removeClass("loading");J.addClass("loading_error")}}}function h(){if(q.length>0){v("rollback")}}function g(G){$("#mode").attr("data-state",G).text(["Обычный ввод","Удалить один раз","Удалять всегда"][G])}function k(){t=false;delete l;i()}function r(H){var S=this.cellIndex;var Q=$(this).parent()[0].sectionRowIndex;var J=$(this).closest(".conduit_container").attr("data-id");var M=$(this).closest(".conduit");var I=[];var P;if(H.altKey||+$("#mode").attr("data-state")){P=""}else{P=$("#autoCaption").val()}if(t){if(S<l.x){var N=S;var O=l.x}else{var N=l.x;var O=S}if(Q<l.y){var R=Q;var G=l.y}else{var R=l.y;var G=Q}for(var L=N;L<=O;L++){for(var K=R;K<=G;K++){w(I,M,L,K,P)}}k();I.List=J;v("update",I)}else{if(H.shiftKey){t=true;l={x:S,y:Q}}else{w(I,M,S,Q,P);I.List=J;v("update",I)}}if($("#mode").attr("data-state")==1){g(0)}}function E(H){H=H||$("#conduits");var G=$("#autoCaption").val();if(G!==""){H.find('.conduit td[data-mark="'+G+'"]').addClass("highlighted")}}function u(){$(".conduit td").removeClass("highlighted")}function m(){u();E()}function D(I){I=I||$("#conduits");var H=$("#teacher").val();var G=$("#pupil").val();if(G===""&&H===""){$("#conduits").find(".conduit tfoot").show();this.show_floating_header=true}else{$("#conduits").find(".conduit tfoot").hide();this.show_floating_header=false}if(G===""){if(H===""){I.find(".conduit tbody tr").show()}else{I.find('.conduit tbody tr:not([data-teacher="'+H+'"])').hide();I.find('.conduit tbody tr[data-teacher="'+H+'"]').show()}}else{I.find('.conduit tbody tr:not([data-pupil="'+G+'"])').hide();I.find('.conduit tbody tr[data-pupil="'+G+'"]').show()}}function A(){$("#pupil").val("");D();q.length=0;$("#undoButton").attr("disabled","disabled")}function B(){D();q.length=0;$("#undoButton").attr("disabled","disabled")}function o(G){if(G===$("#pupil").val()){G=""}$("#pupil").val(G);D()}function y(){var G=$(this).closest("tr").attr("data-pupil");o(G)}function n(){if(longpress){return false}}function x(){var G=$(this).closest("tr").attr("data-pupil");longpress=false;pressTimer=window.setTimeout(function(H){o(H);longpress=true},750,G)}function z(){clearTimeout(pressTimer)}function C(G){var H=String.fromCharCode(G.which);if(G.ctrlKey&&H==="Z"){h()}else{if(G.which===27){k()}}if(!$("#autoCaption").is(":focus")){if(H>="1"&&H<="8"){$(".combobox select").prop("selectedIndex",H-1).change()}if(G.which>=97&&G.which<=104){$(".combobox select").prop("selectedIndex",G.which-97).change()}}}function s(){window.print()}this.init=function(){$("#autoCaption").change(m).keyup(m);var I=$.fn.Today();$("#autoCaption").datepicker({constrainInput:false,showButtonPanel:true,showOtherMonths:true,navigationAsDateFormat:true,changeMonth:true,defaultDate:I}).datepicker("setDate",I);$("#undoButton").click(h).attr("disabled","disabled");$("#mode").click(function(){g(($(this).attr("data-state")+1)%3)});$(".combobox select").change(function(){$(this.nextElementSibling).val(this.value).change();this.selectedIndex=-1}).prop("selectedIndex",-1);$(window).keyup(C);$("#teacher").change(A);$("#pupil").change(B);var H=$("#conduits");H.on({mouseover:d,mouseout:i},".conduit .problemName");H.on({mouseover:f,mouseout:i,dblclick:y},".conduit .pupilName");H.on({click:n,mousedown:x,mouseup:z},".conduit .pupilName");H.on({mouseover:e,mouseout:i,click:r},".conduit td");H.on({mouseleave:k},".conduit");H.on({click:p},".conduit_spoiler");H.on({click:s},".printButton");var K="SPOILER:"+Globals.ClassID,L=(localStorage.getItem(K)||"").split(",");for(var J=1,G=L.length;J<G;++J){$(".conduit_spoiler[data-id="+L[J]+"]").click()}}}window.Conduit=new a()})();