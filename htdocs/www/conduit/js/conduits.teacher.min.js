(function(){function a(){var t=false;var j={};var q=[];var E=true;$.fn.floatHeader=function(){return this.each(function(){var H=$(this);H.floatBox=H.siblings(".floatHeader");var I=H.floatBox.children("table");$(window).scroll(function(){if(p(H,H.floatBox)){if(!H.floatBox.is(":visible")){l(I,H)}H.floatBox.show().css({top:0,left:H.offset().left-$(window).scrollLeft()})}else{H.floatBox.hide()}});$(window).resize(function(){if(H.floatBox.is(":visible")){l(I,H)}});this.fhRecalculate=function(){l(I,H)}})};function l(J,I){var H=I.width();if(navigator.userAgent.indexOf("Firefox")>-1&&H<window.innerWidth){J.css("width","")}else{J.width(H)}var K=J.find("thead th:first-child");I.find("th").each(function(L,M){K=K.width($(M).width()).next()})}function p(K,J){if(!K.is(":visible")||!E){return false}var M=$(window).scrollTop();var L=K.offset().top;var H=K.height()-J.height();var I=K.children("tfoot");if(I.length>0){H-=I.height()}return L<=M&&M<=L+H}function c(){if(t){var H=this.cellIndex;var M=$(this).parent()[0].sectionRowIndex;if(H<j.x){var J=H;var L=j.x}else{var J=j.x;var L=H}if(M<j.y){var I=M;var K=j.y}else{var I=j.y;var K=M}$(this).closest("tbody").children().slice(I,K+1).each(function(){$(this).children(".pupilName").addClass("mouseOver").end().children().slice(J,L+1).addClass("mouseOver")});$(this).closest(".conduit_container").find(".headerRow").each(function(){$(this).children().slice(J,L+1).addClass("mouseOver")})}else{$(this).siblings(".pupilName").andSelf().addClass("mouseOver");$(this).closest(".conduit_container").find(".headerRow").children(":nth-child("+(this.cellIndex+1)+")").addClass("mouseOver")}}function d(){$(this).parent().addClass("mouseOver")}function b(){$(this).closest(".conduit_container").find("tr").children(":nth-child("+(this.cellIndex+1)+")").addClass("mouseOver")}function g(){$(this).closest(".conduit_container").find("*").removeClass("mouseOver")}function o(){var I=Globals.ClassID,K=$(this).closest(".conduit_container"),H=K.attr("data-id");if(K.attr("data-state")==="opened"){K.attr("data-state","closed").removeClass("print");h(I,H,false)}else{if(K.attr("data-state")==="empty"){var J=K.children(".loading");J.show();$.ajax({type:"POST",url:"ajax/GetConduit.php",data:{Class:I,List:H},dataType:"html",success:function(L){J.hide();K.append(L);K.children(".conduit").floatHeader();F(K);D(K)},error:function(L,N,M){alert("Не удалось получить ответ от сервера: "+L.status+" "+N)}})}K.attr("data-state","opened").addClass("print");h(I,H,true)}}function h(J,H,K){var I="ec_open",L=($.cookie(I)||"").split(","),M=$.inArray(H,L);if(K&&(M==-1)){L.push(H)}else{if(!K&&(M!=-1)){L.splice(M,1)}}$.cookie(I,L.join(","),{expires:30})}function w(I,M,L,K,J){$row=M.find("tbody tr").eq(K);if($row.is(":visible")){I.push({Pupil:$row.attr("data-pupil"),Problem:M.find(".headerRow").eq(0).children().eq(L).attr("data-problem"),Mark:J});var H=$row.children().eq(L);H.removeClass("loading_error");H.addClass("loading_mark")}}function v(H,I){if(H==="update"){q.push(I)}else{I=q[q.length-1]}$.ajax({type:"POST",url:"ajax/UpdateMark.php",data:{Request:JSON.stringify(I),Type:H},dataType:"json",context:$('.conduit_container[data-id="'+I.List+'"]>.conduit'),success:function(L){for(var N=0,K=L.length;N<K;N++){var J=this.find(".headerRow").eq(0).children('[data-problem="'+L[N].Problem+'"]')[0].cellIndex;var M=this.find('tr[data-pupil="'+L[N].Pupil+'"]').children().eq(J);M.html(L[N].Text);M.removeClass("loading_mark");if(typeof(L[N].Hint)!=="undefined"){M.attr({"data-mark":L[N].Mark,title:L[N].Hint})}else{M.removeAttr("data-mark").removeAttr("title")}if($("#autoCaption").val()===L[N].Mark&&L[N].Mark!==""){M.addClass("highlighted")}else{M.removeClass("highlighted")}}if(H==="rollback"){q.pop();if(q.length===0){$("#undoButton").attr("disabled","disabled")}}else{$("#undoButton").removeAttr("disabled")}this[0].fhRecalculate()},error:G(I)})}function G(H){return function(Q,J,O){var K="Не удалось обновить данные на сервере: ";var M=H.slice();alert(K+Q.status+" "+J);for(var N=0,L=M.length;N<L;++N){var P=this.find(".headerRow").eq(0).children('[data-problem="'+M[N].Problem+'"]')[0].cellIndex;var I=this.find('tr[data-pupil="'+M[N].Pupil+'"]').children().eq(P);I.removeClass("loading_mark");I.addClass("loading_error")}}}function f(){if(q.length>0){v("rollback")}}function e(H){$("#mode").attr("data-state",H).text(["Обычный ввод","Удалить один раз","Удалять всегда"][H])}function i(){t=false;delete j;g()}function r(I){var T=this.cellIndex;var R=$(this).parent()[0].sectionRowIndex;var K=$(this).closest(".conduit_container").attr("data-id");var N=$(this).closest(".conduit");var J=[];var Q;if(I.altKey||+$("#mode").attr("data-state")){Q=""}else{Q=$("#autoCaption").val()}if(t){if(T<j.x){var O=T;var P=j.x}else{var O=j.x;var P=T}if(R<j.y){var S=R;var H=j.y}else{var S=j.y;var H=R}for(var M=O;M<=P;M++){for(var L=S;L<=H;L++){w(J,N,M,L,Q)}}i();J.List=K;v("update",J)}else{if(I.shiftKey){t=true;j={x:T,y:R}}else{w(J,N,T,R,Q);J.List=K;v("update",J)}}if($("#mode").attr("data-state")==1){e(0)}}function F(I){I=I||$("#conduits");var H=$("#autoCaption").val();if(H!==""){I.find('.conduit td[data-mark="'+H+'"]').addClass("highlighted")}}function u(){$(".conduit td").removeClass("highlighted")}function k(){u();F()}function D(J){J=J||$("#conduits");var I=$("#teacher").val();var H=$("#pupil").val();if(H===""&&I===""){$("#conduits").find(".conduit tfoot").show();E=true}else{$("#conduits").find(".conduit tfoot").hide();E=false}if(H===""){if(I===""){J.find(".conduit tbody tr").show()}else{J.find('.conduit tbody tr:not([data-teacher="'+I+'"])').hide();J.find('.conduit tbody tr[data-teacher="'+I+'"]').show()}}else{J.find('.conduit tbody tr:not([data-pupil="'+H+'"])').hide();J.find('.conduit tbody tr[data-pupil="'+H+'"]').show()}}function A(){$("#pupil").val("");D();q.length=0;$("#undoButton").attr("disabled","disabled")}function B(){D();q.length=0;$("#undoButton").attr("disabled","disabled")}function n(H){if(H===$("#pupil").val()){H=""}$("#pupil").val(H);D()}function y(){var H=$(this).closest("tr").attr("data-pupil");n(H)}function m(){if(longpress){return false}}function x(){var H=$(this).closest("tr").attr("data-pupil");longpress=false;pressTimer=window.setTimeout(function(I){n(I);longpress=true},750,H)}function z(){clearTimeout(pressTimer)}function C(H){var I=String.fromCharCode(H.which);if(H.ctrlKey&&I==="Z"){f()}else{if(H.which===27){i()}}if(!$("#autoCaption").is(":focus")){if(I>="1"&&I<="8"){$(".combobox select").prop("selectedIndex",I-1).change()}if(H.which>=97&&H.which<=104){$(".combobox select").prop("selectedIndex",H.which-97).change()}}}function s(){window.print()}this.init=function(){$("#autoCaption").change(k).keyup(k);var I=$.fn.Today();$("#autoCaption").datepicker({constrainInput:false,showButtonPanel:true,showOtherMonths:true,navigationAsDateFormat:true,changeMonth:true,defaultDate:I}).datepicker("setDate",I);$("#undoButton").click(f).attr("disabled","disabled");$("#mode").click(function(){e(($(this).attr("data-state")+1)%3)});$(".combobox select").change(function(){$(this.nextElementSibling).val(this.value).change();this.selectedIndex=-1}).prop("selectedIndex",-1);$(window).keyup(C);$("#teacher").change(A);$("#pupil").change(B);var H=$("#conduits");H.on({mouseover:b,mouseout:g},".conduit .problemName");H.on({mouseover:d,mouseout:g,dblclick:y},".conduit .pupilName");H.on({click:m,mousedown:x,mouseup:z},".conduit .pupilName");H.on({mouseover:c,mouseout:g,click:r},".conduit td");H.on({mouseleave:i},".conduit");H.on({click:o},".conduit_spoiler");H.on({click:s},".printButton");F();$(".conduit_container>.conduit").floatHeader();D()}}window.Conduit=new a()})();