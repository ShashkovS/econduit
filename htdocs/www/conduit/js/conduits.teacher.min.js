(function(){function a(){var t=false;var j={};var q=[];var E=true;$.fn.floatHeader=function(){return this.each(function(){var G=$(this);G.floatBox=G.siblings(".floatHeader");var H=G.floatBox.children("table");$(window).scroll(function(){if(p(G,G.floatBox)){if(!G.floatBox.is(":visible")){l(H,G)}G.floatBox.show().css({top:0,left:G.offset().left-$(window).scrollLeft()})}else{G.floatBox.hide()}});$(window).resize(function(){if(G.floatBox.is(":visible")){l(H,G)}});this.fhRecalculate=function(){l(H,G)}})};function l(I,H){var G=H.width();if(navigator.userAgent.indexOf("Firefox")>-1&&G<window.innerWidth){I.css("width","")}else{I.width(G)}var J=I.find("thead th:first-child");H.find("th").each(function(K,L){J=J.width($(L).width()).next()})}function p(J,I){if(!J.is(":visible")||!E){return false}var L=$(window).scrollTop();var K=J.offset().top;var G=J.height()-I.height();var H=J.children("tfoot");if(H.length>0){G-=H.height()}return K<=L&&L<=K+G}function c(){if(t){var G=this.cellIndex;var L=$(this).parent()[0].sectionRowIndex;if(G<j.x){var I=G;var K=j.x}else{var I=j.x;var K=G}if(L<j.y){var H=L;var J=j.y}else{var H=j.y;var J=L}$(this).closest("tbody").children().slice(H,J+1).each(function(){$(this).children(".pupilName").addClass("mouseOver").end().children().slice(I,K+1).addClass("mouseOver")});$(this).closest(".conduit_container").find(".headerRow").each(function(){$(this).children().slice(I,K+1).addClass("mouseOver")})}else{$(this).siblings(".pupilName").andSelf().addClass("mouseOver");$(this).closest(".conduit_container").find(".headerRow").children(":nth-child("+(this.cellIndex+1)+")").addClass("mouseOver")}}function d(){$(this).parent().addClass("mouseOver")}function b(){$(this).closest(".conduit_container").find("tr").children(":nth-child("+(this.cellIndex+1)+")").addClass("mouseOver")}function g(){$(this).closest(".conduit_container").find("*").removeClass("mouseOver")}function o(){var H=Globals.ClassID,J=$(this).closest(".conduit_container"),G=J.attr("data-id");if(J.attr("data-state")==="opened"){J.attr("data-state","closed").removeClass("print");h(H,G,false)}else{if(J.attr("data-state")==="empty"){var I=J.children(".loading");I.show();$.ajax({type:"POST",url:"ajax/GetConduit.php",data:{Class:H,List:G},dataType:"html",success:function(K){I.hide();J.append(K);J.children(".conduit").floatHeader();F(J);D(J)},error:function(K,M,L){alert("Не удалось получить ответ от сервера: "+K.status+" "+M)}})}J.attr("data-state","opened").addClass("print");h(H,G,true)}}function h(I,G,J){var H="ec_open",K=($.cookie(H)||"").split(","),L=$.inArray(G,K);if(J&&(L==-1)){K.push(G)}else{if(!J&&(L!=-1)){K.splice(L,1)}}$.cookie(H,K.join(","),{expires:30})}function w(G,K,J,I,H){$row=K.find("tbody tr").eq(I);if($row.is(":visible")){G.push({Pupil:$row.attr("data-pupil"),Problem:K.find(".headerRow").eq(0).children().eq(J).attr("data-problem"),Mark:H})}}function v(G,H){if(G==="update"){q.push(H)}else{H=q[q.length-1]}$.ajax({type:"POST",url:"ajax/UpdateMark.php",data:{Request:JSON.stringify(H),Type:G},dataType:"json",context:$('.conduit_container[data-id="'+H.List+'"]>.conduit'),success:function(K){for(var M=0,J=K.length;M<J;M++){var I=this.find(".headerRow").eq(0).children('[data-problem="'+K[M].Problem+'"]')[0].cellIndex;var L=this.find('tr[data-pupil="'+K[M].Pupil+'"]').children().eq(I);L.html(K[M].Text);if(typeof(K[M].Hint)!=="undefined"){L.attr({"data-mark":K[M].Mark,title:K[M].Hint})}else{L.removeAttr("data-mark").removeAttr("title")}if($("#autoCaption").val()===K[M].Mark&&K[M].Mark!==""){L.addClass("highlighted")}else{L.removeClass("highlighted")}}if(G==="rollback"){q.pop();if(q.length===0){$("#undoButton").attr("disabled","disabled")}}else{$("#undoButton").removeAttr("disabled")}this[0].fhRecalculate()},error:function(I,L,J){var K="Не удалось обновить данные на сервере: ";alert(K+I.status+" "+L)}})}function f(){if(q.length>0){v("rollback")}}function e(G){$("#mode").attr("data-state",G).text(["Обычный ввод","Удалить один раз","Удалять всегда"][G])}function i(){t=false;delete j;g()}function r(H){var S=this.cellIndex;var Q=$(this).parent()[0].sectionRowIndex;var J=$(this).closest(".conduit_container").attr("data-id");var M=$(this).closest(".conduit");var I=[];var P;if(H.altKey||+$("#mode").attr("data-state")){P=""}else{P=$("#autoCaption").val()}if(t){if(S<j.x){var N=S;var O=j.x}else{var N=j.x;var O=S}if(Q<j.y){var R=Q;var G=j.y}else{var R=j.y;var G=Q}for(var L=N;L<=O;L++){for(var K=R;K<=G;K++){w(I,M,L,K,P)}}i();I.List=J;v("update",I)}else{if(H.shiftKey){t=true;j={x:S,y:Q}}else{w(I,M,S,Q,P);I.List=J;v("update",I)}}if($("#mode").attr("data-state")==1){e(0)}}function F(H){H=H||$("#conduits");var G=$("#autoCaption").val();if(G!==""){H.find('.conduit td[data-mark="'+G+'"]').addClass("highlighted")}}function u(){$(".conduit td").removeClass("highlighted")}function k(){u();F()}function D(I){I=I||$("#conduits");var H=$("#teacher").val();var G=$("#pupil").val();if(G===""&&H===""){$("#conduits").find(".conduit tfoot").show();E=true}else{$("#conduits").find(".conduit tfoot").hide();E=false}if(G===""){if(H===""){I.find(".conduit tbody tr").show()}else{I.find('.conduit tbody tr:not([data-teacher="'+H+'"])').hide();I.find('.conduit tbody tr[data-teacher="'+H+'"]').show()}}else{I.find('.conduit tbody tr:not([data-pupil="'+G+'"])').hide();I.find('.conduit tbody tr[data-pupil="'+G+'"]').show()}}function A(){$("#pupil").val("");D();q.length=0;$("#undoButton").attr("disabled","disabled")}function B(){D();q.length=0;$("#undoButton").attr("disabled","disabled")}function n(G){if(G===$("#pupil").val()){G=""}$("#pupil").val(G);D()}function y(){var G=$(this).closest("tr").attr("data-pupil");n(G)}function m(){if(longpress){return false}}function x(){var G=$(this).closest("tr").attr("data-pupil");longpress=false;pressTimer=window.setTimeout(function(H){n(H);longpress=true},750,G)}function z(){clearTimeout(pressTimer)}function C(G){var H=String.fromCharCode(G.which);if(G.ctrlKey&&H==="Z"){f()}else{if(G.which===27){i()}}if(!$("#autoCaption").is(":focus")){if(H>="1"&&H<="8"){$(".combobox select").prop("selectedIndex",H-1).change()}if(G.which>=97&&G.which<=104){$(".combobox select").prop("selectedIndex",G.which-97).change()}}}function s(){window.print()}this.init=function(){$("#autoCaption").change(k).keyup(k);var H=$.fn.Today();$("#autoCaption").datepicker({constrainInput:false,showButtonPanel:true,showOtherMonths:true,navigationAsDateFormat:true,changeMonth:true,defaultDate:H}).datepicker("setDate",H);$("#undoButton").click(f).attr("disabled","disabled");$("#mode").click(function(){e(($(this).attr("data-state")+1)%3)});$(".combobox select").change(function(){$(this.nextElementSibling).val(this.value).change();this.selectedIndex=-1}).prop("selectedIndex",-1);$(window).keyup(C);$("#teacher").change(A);$("#pupil").change(B);var G=$("#conduits");G.on({mouseover:b,mouseout:g},".conduit .problemName");G.on({mouseover:d,mouseout:g,dblclick:y},".conduit .pupilName");G.on({click:m,mousedown:x,mouseup:z},".conduit .pupilName");G.on({mouseover:c,mouseout:g,click:r},".conduit td");G.on({mouseleave:i},".conduit");G.on({click:o},".conduit_spoiler");G.on({click:s},".printButton");F();$(".conduit_container>.conduit").floatHeader()}}window.Conduit=new a()})();