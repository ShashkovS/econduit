(function(){function a(){var d=[];var j=[];var m;var g;function h(q,r,p,s){q.push({Pupil:r,Problem:p,Mark:s})}function i(p,q,r){if(p==="update"){j.push(q)}else{q=j[j.length-1]}$.ajax({type:"POST",url:"ajax/UpdateMark.php",data:{Request:JSON.stringify(q),Type:p},dataType:"json",context:r,success:function(s){g.echo("[[;blue;black]Успешно внесены "+s.length+" задач. :)]");if(p==="rollback"){j.pop()}},error:function(s,v,t){var u="Не удалось обновить данные на сервере: ";alert(u+s.status+" "+v)}})}function e(){if(j.length>0){i("rollback")}else{g.echo("[[;red;black]Откатывать больше нечего :(]")}}function n(){g.echo("[[;orange;black]Синтаксис: школьник листок задачи {стереть}  (или undo)]");g.echo("[[;orange;black]Пример: ива 14 2а,2в,13-15,17а-17г]");g.echo("[[;orange;black]Пример: пе 2д 14 стереть]")}function c(u,s){var r=u.length,q=-1;for(var t=0,p=s.length;t<p;t++){if(u===s[t].Name.toLowerCase().substr(0,r)){q=t;break}}if(q===-1){g.echo("[[;red;black]Школьник, начинающийся на "+u+" не найден.]");return -1}else{g.echo("[[;green;black]Школьник: "+s[q].Name+"]");return s[q].ID}}function k(t,s){var r=-1;for(var q=0,p=s.length;q<p;q++){if(t===s[q].Number){r=q;break}}if(r===-1){g.echo("[[;red;black]Листок "+t+" не найден.]");return -1}else{g.echo("[[;green;black]Листок:   "+t+" - "+s[r].Description+"]");return r}}function b(p,x,z,q){var v=[],B=[],s=q["l"+z[x].ID],A="",y,w;for(var C=0,u=p.length;C<u;C++){A=p[C].split("-");if(A.length==1){y=("0"+A[0]);if("0"<=y.slice(-1)&&y.slice(-1)<="9"){y+="_"}y=y.slice(-3);for(var t=0,r=s.length;t<r;t++){if(s[t].Search.slice(-3)==y||(y.slice(-1)=="_"&&s[t].Search.slice(-3).slice(0,-1)==y.slice(0,-1))){v.push(s[t].Name);B.push(s[t].ID)}}}else{if(A.length==2){y=("0"+A[0]);if("0"<=y.slice(-1)&&y.slice(-1)<="9"){y+="_"}y=y.slice(-3);w=("0"+A[1]);if("0"<=w.slice(-1)&&w.slice(-1)<="9"){w+="_"}w=w.slice(-3);for(var t=0,r=s.length;t<r;t++){if(y<=s[t].Search.slice(-3)&&s[t].Search.slice(-3)<=w){v.push(s[t].Name);B.push(s[t].ID)}}}}}if(v.length===0){g.echo("[[;red;black]Ни одной задачи, подходящей под '"+p+"' не найдено.]");return[]}else{g.echo("[[;green;black]Задачи:   "+v.join(", ")+"]");return B}}function l(q){var p="";if(q=="стереть"){p=""}else{p=m}g.echo("[[;green;black]Метка:    "+p+"]");return p}function o(s,q,r,p){if(q!=-1&&r!=-1&&p.length>0){g.push(function(v){if(v.match(/^да?$/i)){d=[];for(var u=0,t=p.length;u<t;u++){h(d,q,p[u],s)}i("update",d,r);g.pop()}else{if(v.match(/^н(ет?)?$/i)){g.pop()}}},{prompt:"[[;yellow;black]Всё верно (да/нет)?] "})}}function f(r,t,w,p){var x=[],s=-1;var u=c(r[0],t);var v=k(r[1],w);if(v!=-1){s=w[v].ID;x=b(r.slice(2),v,w,p)}var q=l(r.slice(-1));o(q,u,s,x)}this.init=function(q,u,s){g=$("#coduit_terminal").terminal(function(x,v){if(x==="undo"){e()}else{x=x.toLowerCase().replace(/\s*-\s*/g,"-").replace(/![а-я0-9- ]/g,"")+" ";var w=x.match(/[а-я0-9-]+/g);if(!w||w.length<3){n()}else{f(w,q,u,s)}}},{prompt:"conduit> ",name:"Conduit",greetings:""});var r=new Date();var p=("0"+r.getDate()).slice(-2);var t=("0"+(r.getMonth()+1)).slice(-2);m=(p)+"/"+(t)+"/"+r.getFullYear()}}window.Console=new a()})();