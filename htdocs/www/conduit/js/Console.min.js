(function(){function e(){function c(e,t,n,r){e.push({Pupil:t,Problem:n,Mark:r})}function h(e,t,n){if(e==="update"){o.push(t)}else{t=o[o.length-1]}$.ajax({type:"POST",url:"ajax/UpdateMark.php",data:{Request:JSON.stringify(t),Type:e},dataType:"json",context:n,success:function(t){term.echo("[[;blue;black]Успешно внесены "+t.length+" задач. :)]");if(e==="rollback"){o.pop()}},error:function(e,t,n){var r="Не удалось обновить данные на сервере: ";alert(r+e.status+" "+t)}})}function p(){if(o.length>0){h("rollback")}else{term.echo("[[;red;black]Откатывать больше нечего :(]")}}function d(){term.echo("[[;orange;black]Синтаксис: школьник листок задачи {стереть}  (или undo)]");term.echo("[[;orange;black]Пример: ива 14 2а,2в,13-15,17а-17г]");term.echo("[[;orange;black]Пример: пе 2д 14 стереть]")}function v(e,t){var n=e.length,r=-1;for(var i=0,s=t.length;i<s;i++){if(e===t[i].Name.toLowerCase().substr(0,n)){r=i;break}}if(r===-1){term.echo("[[;red;black]Школьник, начинающийся на "+e+" не найден.]");return-1}else{term.echo("[[;green;black]Школьник: "+t[r].Name+"]");return t[r].ID}}function m(e,t){var n=-1;for(var r=0,i=t.length;r<i;r++){if(e===t[r].Number){n=r;break}}if(n===-1){term.echo("[[;red;black]Листок "+e+" не найден.]");return-1}else{term.echo("[[;green;black]Листок:   "+e+" - "+t[n].Description+"]");return n}}function g(e,t,n,r){var i=[],s=[],o=r["l"+n[t].ID],u="";for(var a=0,f=e.length;a<f;a++){u=e[a].split("-");if(u.length==1){cur0="0"+u[0];if("0"<=cur0.slice(-1)&&cur0.slice(-1)<="9"){cur0+="_"}cur0=cur0.slice(-3);for(var l=0,c=o.length;l<c;l++){if(o[l].Search.slice(-3)==cur0||cur0.slice(-1)=="_"&&o[l].Search.slice(-3).slice(0,-1)==cur0.slice(0,-1)){i.push(o[l].Name);s.push(o[l].ID)}}}else if(u.length==2){cur0="0"+u[0];if("0"<=cur0.slice(-1)&&cur0.slice(-1)<="9"){cur0+="_"}cur0=cur0.slice(-3);cur1="0"+u[1];if("0"<=cur1.slice(-1)&&cur1.slice(-1)<="9"){cur1+="_"}cur1=cur1.slice(-3);for(var l=0,c=o.length;l<c;l++){if(cur0<=o[l].Search.slice(-3)&&o[l].Search.slice(-3)<=cur1){i.push(o[l].Name);s.push(o[l].ID)}}}}if(i.length===0){term.echo("[[;red;black]Ни одной задачи, подходящей под '"+e+"' не найдено.]");return[]}else{term.echo("[[;green;black]Задачи:   "+i.join(", ")+"]");return s}}function y(e){var t="";if(e=="стереть"){t=""}else{t=l}term.echo("[[;green;black]Метка:    "+t+"]");return t}function b(e,t,n,r){if(t!=-1&&n!=-1&&r.length>0){term.push(function(i){if(i.match(/д|да/i)){s=[];for(var o=0,u=r.length;o<u;o++){c(s,t,r[o],e)}h("update",s,n);term.pop()}else if(i.match(/н|не|нет/i)){term.pop()}},{prompt:"[[;yellow;black]Всё верно (да/нет)?] "})}}function w(e,t,n,r){var i=[],s=-1;var o=v(e[0],t);var u=m(e[1],n);if(u!=-1){s=n[u].ID;i=g(e.slice(2),u,n,r)}var a=y(e.slice(-1));b(a,o,s,i)}var e=-1,t=-1,n=-1,r=-1,i=[];var s=[];var o=[];var u=new Date;var a=("0"+u.getDate()).slice(-2);var f=("0"+(u.getMonth()+1)).slice(-2);var l=a+"/"+f+"/"+u.getFullYear();this.init=function(e,t,n){term=$("#coduit_terminal").terminal(function(r,i){if(r==="undo"){p()}else{r=r.toLowerCase().replace(/\s*-\s*/g,"-").replace(/![а-я0-9- ]/g,"")+" ";var s=r.match(/[а-я0-9-]+/g);if(!s||s.length<3){d()}else{w(s,e,t,n)}}},{prompt:"conduit> ",name:"Conduit",greetings:""})}}window.Console=new e})()